let recognizing = false;

function startSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window) || recognizing) return;

  const recog = new webkitSpeechRecognition();
  recog.lang = 'ko-KR';
  recog.interimResults = false;
  recog.maxAlternatives = 1;
  recognizing = true;

  recog.onresult = function(event) {
    const said = event.results[0][0].transcript.trim();
    const answer = cards[current].back.trim();
    if (said === answer) {
      document.getElementById("correctSound").play();
      showInlineMessage(`‚úÖ Ï†ïÎãµ! (${said})`);
      nextCard();
    } else {
      document.getElementById("wrongSound").play();
      showInlineMessage(`‚ùå ${said} ‚Üí Ï†ïÎãµ: ${answer}`);
      markWrong();
    }
  };

  recog.onerror = function() {
    showInlineMessage("‚ùó ÏùåÏÑ± Ïù∏Ïãù Ïã§Ìå®");
    document.getElementById("voiceHint").textContent = "‚ùó Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî";
  };

  recog.onend = function() {
    recognizing = false;
    document.getElementById("voiceHint").textContent = "";
  };

  recog.start();
  document.getElementById("voiceHint").textContent = "üó£Ô∏è ÎßêÌïòÏÑ∏Ïöî...";
}

if ('webkitSpeechRecognition' in window) {
  useSpeech = true;
  const speechBtn = document.getElementById("speechBtn");
  if (speechBtn) speechBtn.style.display = "none";

  setInterval(() => {
    if (useSpeech && showingFront && !recognizing) {
      startSpeechRecognition();
    }
  }, 2000);
} else {
  useSpeech = false;
  const speechBtn = document.getElementById("speechBtn");
  if (speechBtn) speechBtn.style.display = "none";
}

function updateCard() {
  if (cards.length === 0) return;
  showingFront = true;
  const content = cards[current].front;
  card.textContent = content;
  card.appendChild(document.getElementById("inlineMessage"));
  speak(content, "en-US");
  document.getElementById("counter").textContent = `${current + 1} / ${cards.length}`;
  document.getElementById("selfCheckBtns").style.display = 'none';
  document.getElementById("voiceHint").textContent = useSpeech ? "üó£Ô∏è ÎßêÌïòÏÑ∏Ïöî..." : "";
}
